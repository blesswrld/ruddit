generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql" // Указываем, что у нас PostgreSQL
  url          = env("DATABASE_URL") // Prisma возьмет URL из .env файла
  relationMode = "prisma"
}

// Описываем нашу первую модель - Пользователь
model User {
  id           String   @id @default(cuid()) // Уникальный ID
  username     String   @unique // Имя пользователя, должно быть уникальным
  email        String   @unique // Email, тоже уникальный
  passwordHash String   // Здесь будет храниться ЗАХЕШИРОВАННЫЙ пароль
  createdAt    DateTime @default(now()) // Дата создания
  updatedAt    DateTime @updatedAt // Дата обновления

  // Связь с созданными сообществами
  createdCommunities Community[] @relation("CreatedCommunities")

  posts Post[] 

  votes Vote[]

  comments Comment[]
}

model Community {
  id          String   @id @default(cuid())
  name        String   // Название сообщества
  slug        String   @unique // Слаг должен быть уникальным
  description String?  // Описание, необязательное
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связь с создателем
  creatorId   String
  creator     User     @relation("CreatedCommunities", fields: [creatorId], references: [id])

  posts Post[]
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId  String
  author    User     @relation(fields: [authorId], references: [id])

  communityId String
  community   Community @relation(fields: [communityId], references: [id])

  votes Vote[]

  comments Comment[]
}

enum VoteType {
  UP
  DOWN
}

model Vote {
  userId String
  postId String
  type   VoteType

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId]) // Составной ключ: пара (user, post) уникальна
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())

  // Связь с автором
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Связь с постом
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Связь для ответов (self-relation)
  replyToId String?
  replyTo   Comment?  @relation("Replies", fields: [replyToId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  replies   Comment[] @relation("Replies")
}